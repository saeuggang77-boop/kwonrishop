generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  BUYER
  SELLER
  AGENT
  FRANCHISE
  EXPERT
  ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PENDING_VERIFICATION
  HIDDEN
  SOLD
  EXPIRED
  DELETED
}

enum BusinessCategory {
  KOREAN_FOOD
  CHINESE_FOOD
  JAPANESE_FOOD
  WESTERN_FOOD
  CHICKEN
  PIZZA
  CAFE_BAKERY
  BAR_PUB
  BUNSIK
  DELIVERY
  OTHER_FOOD
  SERVICE
  RETAIL
  ENTERTAINMENT
  EDUCATION
  ACCOMMODATION
  OTHER
  // 2026-02 추가
  ASIAN_FOOD
  MEAT
  BURGER
  NIGHTCLUB
}

enum StoreType {
  GENERAL_STORE
  FRANCHISE
  FOOD_STREET
  OFFICE
  COMPLEX_MALL
  OTHER
}

enum DocumentType {
  REGISTRY_COPY
  BUILDING_LEDGER
  LAND_LEDGER
  CADASTRAL_MAP
  CONTRACT
  ID_VERIFICATION
  BUSINESS_LICENSE
  OTHER
}

enum DocumentAccessLevel {
  PUBLIC
  BUYER_ONLY
  ADMIN_ONLY
  OWNER_ONLY
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  CANCELLED
  REFUNDED
  PARTIAL_REFUND
}

enum PaymentType {
  PREMIUM_SUBSCRIPTION
  DEEP_REPORT
  FEATURED_LISTING
  ADVERTISEMENT
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
  TRIAL
}

enum SafetyGrade {
  A
  B
  C
  D // deprecated: 프로덕션 DB 호환용, C와 동일 처리
}

enum FraudRuleType {
  DUPLICATE_PHOTO
  PRICE_SPIKE
  MULTI_ACCOUNT_CONTACT
  SUSPICIOUS_DESCRIPTION
  RAPID_RELISTING
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudViolationStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

enum AdminActionType {
  APPROVE
  REJECT
  REQUEST_MORE_INFO
  HIDE_LISTING
  RESTORE_LISTING
  SUSPEND_USER
  UNSUSPEND_USER
}

enum ReportStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

enum EventType {
  VIEW_LISTING
  CLICK_CTA
  INQUIRY_SENT
  PURCHASE_PREMIUM
  UPLOAD_DOCUMENT
  DOWNLOAD_REPORT
  SEARCH_PERFORMED
  LISTING_CREATED
  LISTING_UPDATED
  PAYMENT_COMPLETED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ExpertCategory {
  LAW
  INTERIOR
  DEMOLITION
  ACCOUNTING
  REALESTATE
}

enum InquiryStatus {
  PENDING
  REPLIED
  COMPLETED
  CANCELLED
}

enum PremiumAdTier {
  BASIC
  PREMIUM
  VIP
}

enum PremiumAdStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaidServiceType {
  JUMP_UP
  URGENT_TAG
  AUTO_REFRESH
}

enum ReportPlanTier {
  BASIC
  PREMIUM
}

enum ReportPurchaseStatus {
  PENDING
  PAID
  COMPLETED
}

// ============================================================
// AUTH (NextAuth.js v5 / Auth.js)
// ============================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// USER
// ============================================================

model User {
  id               String           @id @default(cuid())
  name             String?
  email            String?          @unique
  emailVerified    DateTime?
  image            String?
  phone            String?          @unique
  hashedPassword   String?
  role             UserRole         @default(BUYER)
  accountStatus    AccountStatus    @default(ACTIVE)
  businessName     String?
  businessNumber   String?
  subscriptionTier SubscriptionTier @default(FREE)
  expertCategory   String?
  isTrustedSeller  Boolean          @default(false)
  smsNotificationEnabled Boolean    @default(true)
  violationCount   Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  accounts        Account[]
  sessions        Session[]
  listings        Listing[]
  documents       Document[]
  inquiriesSent   Inquiry[]          @relation("InquirySender")
  inquiriesRecv   Inquiry[]          @relation("InquiryReceiver")
  payments        Payment[]
  subscription    Subscription?
  reports         Report[]
  events          Event[]
  fraudFlags      FraudViolation[]   @relation("FlaggedUser")
  adminActions    AdminAuditLog[]    @relation("AdminActor")
  settlements      Settlement[]
  notifications    Notification[]
  reportPurchases  ReportPurchase[]
  simulations      Simulation[]
  expertInquiries  ExpertInquiry[]
  expertReviews    ExpertReview[]
  listingLikes     ListingLike[]
  listingComments  ListingComment[]
  salesIntegrations SalesIntegration[]
  paidServices     PaidService[]
  singlePurchases  SinglePurchase[]
  premiumOffers    PremiumOffer[]

  @@index([role])
  @@index([accountStatus])
  @@map("users")
}

// ============================================================
// LISTING
// ============================================================

model Listing {
  id               String           @id @default(cuid())
  sellerId         String
  title            String
  description      String           @db.Text
  transferReason   String?          @db.Text  // 양도사유
  businessCategory BusinessCategory
  storeType        StoreType
  businessSubtype  String?          // 세부업종 (자유입력)
  price            BigInt           // 보증금
  monthlyRent      BigInt?          // 월세
  premiumFee       BigInt?          // 권리금
  goodwillPremium     Int?          // 영업권리금 (만원)
  goodwillPremiumDesc String?       @db.Text  // 영업권리금 설명
  facilityPremium     Int?          // 시설권리금 (만원)
  facilityPremiumDesc String?       @db.Text  // 시설권리금 설명
  floorPremium        Int?          // 바닥권리금 (만원)
  floorPremiumDesc    String?       @db.Text  // 바닥권리금 설명
  managementFee    BigInt?          // 관리비
  monthlyRevenue   BigInt?          // 월매출
  monthlyProfit    BigInt?          // 월수익
  operatingYears   Int?             // 영업기간(년)
  address          String
  addressDetail    String?
  city             String
  district         String
  neighborhood     String?
  postalCode       String?
  latitude         Float?
  longitude        Float?
  areaM2           Float?
  areaPyeong       Float?
  floor            Int?
  totalFloors      Int?
  unit             String?          // 호수 (예: "101호")
  status           ListingStatus    @default(DRAFT)
  isFeatured       Boolean          @default(false)
  safetyGrade      SafetyGrade?
  safetyComment    String?          // 등급 판정 요약
  isPremium        Boolean          @default(false)
  isRecommended    Boolean          @default(false)
  hasDiagnosisBadge Boolean         @default(false)
  premiumRank      Int              @default(0)
  premiumExposureOrder  Int         @default(0)
  recommendExposureOrder Int        @default(0)
  listingExposureOrder  Int         @default(0)

  // 점프업 (24시간 상단 고정)
  isJumpUp              Boolean   @default(false)
  jumpUpExpiresAt       DateTime?
  jumpUpExposureOrder   Int       @default(0)

  // 급매 태그 (30일 빨간 뱃지)
  isUrgent              Boolean   @default(false)
  urgentExpiresAt       DateTime?

  viewCount        Int              @default(0)
  inquiryCount     Int              @default(0)
  likeCount        Int              @default(0)
  favoriteCount    Int              @default(0)
  contactPhone     String?
  contactEmail     String?
  isPhonePublic    Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  publishedAt      DateTime?
  expiresAt        DateTime?

  seller          User              @relation(fields: [sellerId], references: [id])
  images          ListingImage[]
  documents       Document[]
  inquiries       Inquiry[]
  fraudViolations FraudViolation[]
  comparisons     ListingComparison[]
  reports         Report[]
  events          Event[]
  premiumListings  PremiumListing[]
  reportPurchases  ReportPurchase[]
  reportData       ReportData[]
  simulations      Simulation[]
  expertInquiries  ExpertInquiry[]
  likes            ListingLike[]
  comments         ListingComment[]
  salesIntegrations SalesIntegration[]
  diagnosisReport  DiagnosisReport?
  paidServices     PaidService[]
  singlePurchases  SinglePurchase[]
  premiumOffers    PremiumOffer[]

  @@index([sellerId])
  @@index([status])
  @@index([businessCategory])
  @@index([storeType])
  @@index([city, district])
  @@index([price])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@index([isJumpUp, jumpUpExposureOrder])
  @@map("listings")
}

model PremiumOffer {
  id          String   @id @default(cuid())
  listingId   String
  userId      String
  offerAmount Int      // 제안 금액 (만원)
  reason      String   @db.Text
  status      String   @default("pending") // pending, accepted, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@map("premium_offers")
}

model ListingLike {
  id        String   @id @default(cuid())
  listingId String
  userId    String
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
  @@index([userId])
  @@index([listingId])
  @@map("listing_likes")
}

model ListingImage {
  id             String   @id @default(cuid())
  listingId      String
  url            String
  s3Key          String
  thumbnailUrl   String?
  perceptualHash String?
  averageHash    String?
  sortOrder      Int      @default(0)
  isPrimary      Boolean  @default(false)
  width          Int?
  height         Int?
  sizeBytes      Int?
  mimeType       String?
  createdAt      DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([perceptualHash])
  @@map("listing_images")
}

// ============================================================
// DOCUMENT (task 012)
// ============================================================

model Document {
  id              String              @id @default(cuid())
  uploaderId      String
  listingId       String?
  documentType    DocumentType
  fileName        String
  mimeType        String
  sizeBytes       Int
  s3Key           String
  kmsKeyId        String?
  encryptionIv    String?
  accessLevel     DocumentAccessLevel @default(OWNER_ONLY)
  expiresAt       DateTime?
  isDeleted       Boolean             @default(false)
  deletedAt       DateTime?
  consentGiven    Boolean             @default(false)
  consentGivenAt  DateTime?
  hasClientMask   Boolean             @default(false)
  maskRegions     Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  uploader User     @relation(fields: [uploaderId], references: [id])
  listing  Listing? @relation(fields: [listingId], references: [id])

  @@index([uploaderId])
  @@index([listingId])
  @@index([expiresAt])
  @@index([documentType])
  @@map("documents")
}

// ============================================================
// INQUIRY
// ============================================================

model Inquiry {
  id          String        @id @default(cuid())
  listingId   String
  senderId    String
  receiverId  String
  message     String        @db.Text
  senderName  String?
  senderPhone String?
  status      InquiryStatus @default(PENDING)
  isRead      Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  listing  Listing @relation(fields: [listingId], references: [id])
  sender   User    @relation("InquirySender", fields: [senderId], references: [id])
  receiver User    @relation("InquiryReceiver", fields: [receiverId], references: [id])

  @@index([listingId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@index([status])
  @@map("inquiries")
}

// ============================================================
// PAYMENT (TossPayments)
// ============================================================

model Payment {
  id              String        @id @default(cuid())
  userId          String
  orderId         String        @unique
  tossPaymentKey  String?       @unique
  tossOrderName   String?
  amount          BigInt
  paymentType     PaymentType
  paymentStatus   PaymentStatus @default(PENDING)
  method          String?
  cardCompany     String?
  cardNumber      String?
  receiptUrl      String?
  refundAmount    BigInt?
  refundReason    String?
  refundedAt      DateTime?
  metadata        Json?
  paidAt          DateTime?
  failedAt        DateTime?
  failReason      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user         User        @relation(fields: [userId], references: [id])
  report       Report?
  settlement   Settlement? @relation(fields: [settlementId], references: [id])
  settlementId String?

  @@index([userId])
  @@index([paymentStatus])
  @@index([paymentType])
  @@index([createdAt])
  @@map("payments")
}

// ============================================================
// SUBSCRIPTION
// ============================================================

model SubscriptionPlan {
  id            String           @id @default(cuid())
  name          SubscriptionTier @unique
  displayName   String
  price         Int              // monthly price in KRW (0, 9900, 29900)
  yearlyPrice   Int              // yearly price in KRW (0, 95040, 287040) - 20% discount
  features      Json             // array of feature objects
  sortOrder     Int              @default(0)
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                 String             @id @default(cuid())
  userId             String             @unique
  tier               SubscriptionTier   @default(FREE)
  status             SubscriptionStatus @default(ACTIVE)
  billingKey         String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?
  cancelReason       String?
  planId             String?
  autoRenew          Boolean            @default(true)
  paymentMethod      String?            // "CARD" or "TRANSFER"
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user User              @relation(fields: [userId], references: [id])
  plan SubscriptionPlan? @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

// ============================================================
// FRAUD DETECTION (task 011)
// ============================================================

model FraudRule {
  id          String        @id @default(cuid())
  ruleType    FraudRuleType
  name        String
  description String?
  parameters  Json
  isActive    Boolean       @default(true)
  severity    FraudSeverity @default(MEDIUM)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  violations FraudViolation[]

  @@map("fraud_rules")
}

model FraudViolation {
  id         String               @id @default(cuid())
  listingId  String
  userId     String
  ruleId     String
  severity   FraudSeverity
  status     FraudViolationStatus @default(PENDING)
  details    Json
  reviewedBy String?
  reviewedAt DateTime?
  reviewNote String?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  listing Listing   @relation(fields: [listingId], references: [id])
  user    User      @relation("FlaggedUser", fields: [userId], references: [id])
  rule    FraudRule @relation(fields: [ruleId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@map("fraud_violations")
}

// ============================================================
// ADMIN AUDIT (task 014)
// ============================================================

model AdminAuditLog {
  id         String          @id @default(cuid())
  adminId    String
  action     AdminActionType
  targetType String
  targetId   String
  reason     String?
  metadata   Json?
  createdAt  DateTime        @default(now())

  admin User @relation("AdminActor", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ============================================================
// REPORT (tasks 013, 018)
// ============================================================

model Report {
  id               String       @id @default(cuid())
  userId           String
  listingId        String
  paymentId        String?      @unique
  status           ReportStatus @default(QUEUED)
  dataSources      Json?
  modelAssumptions Json?
  modelVersion     String?
  generatedAt      DateTime?
  legalDisclaimer  String?      @db.Text
  s3Key            String?
  downloadUrl      String?
  emailSentAt      DateTime?
  errorMessage     String?
  retryCount       Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  listing Listing  @relation(fields: [listingId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@map("reports")
}

// ============================================================
// EVENTS & ANALYTICS (task 016)
// ============================================================

model Event {
  id        String    @id @default(cuid())
  userId    String?
  listingId String?
  eventType EventType
  metadata  Json?
  sessionId String?
  ipAddress String?
  userAgent String?
  referrer  String?
  createdAt DateTime  @default(now())

  user    User?    @relation(fields: [userId], references: [id])
  listing Listing? @relation(fields: [listingId], references: [id])

  @@index([eventType])
  @@index([userId])
  @@index([listingId])
  @@index([createdAt])
  @@map("events")
}

model DailyListingMetric {
  id            String   @id @default(cuid())
  listingId     String
  date          DateTime @db.Date
  viewCount     Int      @default(0)
  ctaClickCount Int      @default(0)
  inquiryCount  Int      @default(0)
  favoriteCount Int      @default(0)
  createdAt     DateTime @default(now())

  @@unique([listingId, date])
  @@index([listingId])
  @@index([date])
  @@map("daily_listing_metrics")
}

model DailySellerMetric {
  id             String   @id @default(cuid())
  sellerId       String
  date           DateTime @db.Date
  totalViews     Int      @default(0)
  totalInquiries Int      @default(0)
  totalCtaClicks Int      @default(0)
  conversionRate Float?
  activeListings Int      @default(0)
  newListings    Int      @default(0)
  createdAt      DateTime @default(now())

  @@unique([sellerId, date])
  @@index([sellerId])
  @@index([date])
  @@map("daily_seller_metrics")
}

// ============================================================
// COMPARABLE LISTINGS (task 017)
// ============================================================

model ListingComparison {
  id              String   @id @default(cuid())
  listingId       String
  radiusKm        Float
  comparableCount Int      @default(0)
  avgPremiumFee   BigInt?
  avgRentPrice    BigInt?
  avgSalePrice    BigInt?
  medianPrice     BigInt?
  minPrice        BigInt?
  maxPrice        BigInt?
  pricePercentile Float?
  computedAt      DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id])

  @@unique([listingId, radiusKm])
  @@index([listingId])
  @@map("listing_comparisons")
}

// ============================================================
// SETTLEMENT (task 020)
// ============================================================

model Settlement {
  id            String           @id @default(cuid())
  sellerId      String
  periodStart   DateTime
  periodEnd     DateTime
  totalAmount   BigInt
  feeAmount     BigInt
  netAmount     BigInt
  status        SettlementStatus @default(PENDING)
  bankCode      String?
  accountNumber String?
  accountHolder String?
  processedAt   DateTime?
  emailSentAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  seller   User      @relation(fields: [sellerId], references: [id])
  payments Payment[]

  @@index([sellerId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("settlements")
}

// ============================================================
// NOTIFICATION
// ============================================================

model Notification {
  id         String   @id @default(cuid())
  userId     String
  title      String
  message    String   @db.Text
  link       String?
  isRead     Boolean  @default(false)
  readAt     DateTime?
  sourceType String?
  sourceId   String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================
// LISTING COMMENTS
// ============================================================

model ListingComment {
  id        String   @id @default(cuid())
  listingId String
  userId    String
  content   String   @db.Text
  isSecret  Boolean  @default(false)
  parentId  String?
  createdAt DateTime @default(now())

  listing Listing          @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  ListingComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies ListingComment[] @relation("CommentReplies")

  @@index([listingId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("listing_comments")
}

// ============================================================
// LEGAL (task 015)
// ============================================================

model LegalDocument {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  content       String   @db.Text
  version       String
  isActive      Boolean  @default(true)
  effectiveDate DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  consents UserConsent[]

  @@map("legal_documents")
}

model UserConsent {
  id              String   @id @default(cuid())
  userId          String
  legalDocumentId String
  consentedAt     DateTime @default(now())
  ipAddress       String?
  userAgent       String?

  legalDocument LegalDocument @relation(fields: [legalDocumentId], references: [id])

  @@unique([userId, legalDocumentId])
  @@index([userId])
  @@map("user_consents")
}

// ============================================================
// FRANCHISE
// ============================================================

model Franchise {
  id              String   @id @default(cuid())
  brandName       String
  category        String   // 외식/도소매/서비스
  subcategory     String   // 한식/커피/치킨 등
  logoUrl         String?
  monthlyAvgSales BigInt?  // 월 평균 매출액
  startupCost     BigInt?  // 창업비용
  storeCount      Int?     // 가맹+직영점 수
  dataYear        Int?     // 데이터 기준년도
  description     String?  @db.Text
  isPromoting     Boolean  @default(false)
  favoriteCount   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([subcategory])
  @@map("franchises")
}

// ============================================================
// BOARD (창업정보 게시판)
// ============================================================

model BoardPost {
  id           String   @id @default(cuid())
  authorId     String?
  category     String   // 창업정보, 뉴스, 팁 등
  title        String
  content      String   @db.Text
  thumbnailUrl String?
  viewCount    Int      @default(0)
  isPublished  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([createdAt])
  @@map("board_posts")
}

model Banner {
  id        String   @id @default(cuid())
  title     String
  subtitle  String?
  ctaText   String?
  imageUrl  String
  linkUrl   String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
  @@map("banners")
}

// ============================================================
// PREMIUM AD SYSTEM
// ============================================================

model PremiumPlan {
  id            String         @id @default(cuid())
  name          PremiumAdTier  @unique
  displayName   String
  price         BigInt
  durationDays  Int
  features      Json
  sortOrder     Int            @default(0)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  subscriptions PremiumListing[]
  @@map("premium_plans")
}

model PremiumListing {
  id             String          @id @default(cuid())
  listingId      String
  planId         String
  status         PremiumAdStatus @default(ACTIVE)
  startDate      DateTime        @default(now())
  endDate        DateTime
  paymentMethod  String?
  paymentStatus  String          @default("PENDING")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  listing Listing     @relation(fields: [listingId], references: [id])
  plan    PremiumPlan @relation(fields: [planId], references: [id])

  @@index([listingId])
  @@index([status])
  @@index([endDate])
  @@map("premium_listings")
}

// ============================================================
// REPORT ANALYSIS SYSTEM (권리분석 리포트)
// ============================================================

model ReportPlan {
  id          String         @id @default(cuid())
  name        ReportPlanTier @unique
  displayName String
  price       BigInt
  features    Json
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  purchases ReportPurchase[]
  @@map("report_plans")
}

model ReportPurchase {
  id            String               @id @default(cuid())
  userId        String
  listingId     String?
  planId        String
  status        ReportPurchaseStatus @default(PENDING)
  paymentMethod String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  user    User           @relation(fields: [userId], references: [id])
  listing Listing?       @relation(fields: [listingId], references: [id])
  plan    ReportPlan     @relation(fields: [planId], references: [id])
  data    ReportData?

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@map("report_purchases")
}

model ReportData {
  id             String   @id @default(cuid())
  purchaseId     String   @unique
  listingId      String?
  inputData      Json
  analysisResult Json
  pdfUrl         String?
  createdAt      DateTime @default(now())

  purchase ReportPurchase @relation(fields: [purchaseId], references: [id])
  listing  Listing?       @relation(fields: [listingId], references: [id])

  @@index([listingId])
  @@map("report_data")
}

// ============================================================
// MARKET PRICE (시세 비교)
// ============================================================

model MarketPrice {
  id              String           @id @default(cuid())
  region          String           // 시/도 (서울특별시)
  subRegion       String           // 구/군 (강남구)
  businessType    BusinessCategory
  avgDeposit      BigInt           // 평균 보증금
  avgMonthlyRent  BigInt           // 평균 월세
  avgKeyMoney     BigInt           // 평균 권리금
  avgMonthlySales BigInt           // 평균 월매출
  sampleCount     Int              @default(0)
  updatedAt       DateTime         @updatedAt
  createdAt       DateTime         @default(now())

  @@unique([region, subRegion, businessType])
  @@index([region, subRegion])
  @@index([businessType])
  @@map("market_prices")
}

// ============================================================
// SIMULATION (창업 시뮬레이션)
// ============================================================

model Simulation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  input     Json
  result    Json
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("simulations")
}

// ============================================================
// EXPERT SYSTEM (전문가 상담)
// ============================================================

model Expert {
  id            String          @id @default(cuid())
  name          String
  profileImage  String?
  category      ExpertCategory
  title         String          // 직함 (예: 변호사, 세무사)
  company       String?
  career        Int             // 경력 년수
  description   String?         @db.Text
  specialties   Json            // 전문분야 배열 ["권리금분쟁", "임대차계약"]
  rating        Float           @default(0)
  reviewCount   Int             @default(0)
  consultCount  Int             @default(0)
  phone         String?
  email         String?
  region        String          // 활동 지역 (예: "서울특별시")
  isVerified    Boolean         @default(false)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  inquiries     ExpertInquiry[]
  reviews       ExpertReview[]

  @@index([category])
  @@index([region])
  @@index([rating])
  @@map("experts")
}

model ExpertInquiry {
  id         String        @id @default(cuid())
  expertId   String
  userId     String
  listingId  String?
  category   String        // 상담 카테고리 (권리금분쟁, 임대차계약 등)
  subject    String
  message    String        @db.Text
  status     InquiryStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  expert     Expert        @relation(fields: [expertId], references: [id])
  user       User          @relation(fields: [userId], references: [id])
  listing    Listing?      @relation(fields: [listingId], references: [id])
  review     ExpertReview?

  @@index([expertId])
  @@index([userId])
  @@index([status])
  @@map("expert_inquiries")
}

model ExpertReview {
  id         String   @id @default(cuid())
  expertId   String
  userId     String
  inquiryId  String   @unique
  rating     Int      // 1~5
  content    String   @db.Text
  createdAt  DateTime @default(now())

  expert     Expert        @relation(fields: [expertId], references: [id])
  user       User          @relation(fields: [userId], references: [id])
  inquiry    ExpertInquiry @relation(fields: [inquiryId], references: [id])

  @@index([expertId])
  @@map("expert_reviews")
}

// ============================================================
// PAID SERVICE (소액 유료 서비스)
// ============================================================

model PaidService {
  id        String          @id @default(cuid())
  userId    String
  listingId String
  type      PaidServiceType
  status    String          @default("ACTIVE") // ACTIVE, EXPIRED
  reason    String?         // 급매 사유 (URGENT_TAG용)
  price     Int
  startDate DateTime        @default(now())
  endDate   DateTime
  createdAt DateTime        @default(now())

  user    User    @relation(fields: [userId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])

  @@index([listingId, type, status])
  @@index([userId])
  @@index([endDate])
  @@map("paid_services")
}

// ============================================================
// DIAGNOSIS REPORT (권리진단서)
// ============================================================

model DiagnosisReport {
  id                  String   @id @default(cuid())
  listingId           String   @unique
  fairPremiumBusiness Int      // 영업권리금
  fairPremiumFacility Int      // 시설권리금
  fairPremiumFloor    Int      // 바닥권리금
  fairPremiumTotal    Int      // 적정 권리금 합계
  premiumGap          Float    // (실제-적정)/적정 × 100
  premiumVerdict      String   // 적정, 다소 높음, 매우 높음, 저평가
  profitMargin        Float    // 영업이익률
  avgProfitMargin     Float    // 업종 평균 영업이익률
  roiMonths           Int      // 투자회수 기간(개월)
  avgRoiMonths        Int      // 업종 평균 투자회수 기간
  profitRating        Int      // 수익성 등급 (1-5)
  footTraffic         String   // 유동인구 수준
  competitorDensity   String   // 경쟁 밀도
  stationDistance     String   // 역세권 여부
  locationRating      Int      // 입지 등급 (1-5)
  leaseRemaining      String   // 임대차 잔여기간
  buildingAge         String   // 건물 연식
  premiumProtection   Boolean  // 권리금 보호 대상 여부
  riskRating          Int      // 리스크 등급 (1-5)
  overallGrade        String   // 종합 등급 (A+, A, A-, B+, B, B-, C)
  overallComment      String   // 종합 코멘트
  diagnosisNumber     String   @unique // KR-2026-0001
  createdAt           DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id])

  @@index([listingId])
  @@map("diagnosis_reports")
}

// ============================================================
// SALES INTEGRATION (매출 인증 연동)
// ============================================================

model SalesIntegration {
  id           String    @id @default(cuid())
  userId       String
  listingId    String?
  provider     String    // hometax, crefia, baemin, yogiyo, coupangeats
  status       String    @default("pending") // pending, connected, failed, expired
  accessToken  String?   // 암호화 저장 필요
  refreshToken String?   // 암호화 저장 필요
  lastSynced   DateTime?
  salesData    Json?     // 연동된 매출 데이터
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@unique([userId, provider])
  @@index([listingId])
  @@map("sales_integrations")
}

// ============================================================
// SINGLE PURCHASE (건별 수익분석 열람)
// ============================================================

model SinglePurchase {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  expiresAt DateTime // 구매 후 7일
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])

  @@index([userId, listingId])
  @@index([expiresAt])
  @@map("single_purchases")
}
